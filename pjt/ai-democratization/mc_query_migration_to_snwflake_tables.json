{
  "name": "mc_query_migration_to_snwflake_tables",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "dc5f7b51-3b1f-443b-9b76-8721da4fb9fd",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        660,
        0
      ],
      "id": "ca079bb5-49ea-4414-a592-535d9aec3a3a",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "11mpWBcHkLxiZnelOFX1Mdo920GmdZsbV6a_RyyGW32s",
          "mode": "list",
          "cachedResultName": "SMC_ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11mpWBcHkLxiZnelOFX1Mdo920GmdZsbV6a_RyyGW32s/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "ã‚·ãƒ¼ãƒˆ1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11mpWBcHkLxiZnelOFX1Mdo920GmdZsbV6a_RyyGW32s/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        220,
        0
      ],
      "id": "5b3ee0a0-71fc-4646-8569-5ae58616c501",
      "name": "Google Sheetsèª­ã¿è¾¼ã¿",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "QNJk0anZquSFmKYH",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Googleã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Automationä¸€è¦§ã‚’æŠ½å‡º\nconst items = $input.all();\nconst automationSet = new Set();\n\nitems.forEach(item => {\n  const automationName = item.json.automation_en;\n  if (automationName && automationName.trim() !== '' && automationName !== 'automation_en') {\n    automationSet.add(automationName.trim());\n  }\n});\n\nconst automationList = Array.from(automationSet).sort();\n\nreturn automationList.map(automationName => ({\n  json: { automation_name_en: automationName }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        440,
        0
      ],
      "id": "abcfa549-6781-4204-bca4-72b9b4bbec1b",
      "name": "Automationä¸€è¦§æŠ½å‡º"
    },
    {
      "parameters": {
        "jsCode": "// ç¾åœ¨ã®Automationã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º\nconst currentAutomation = $json.automation_name_en;\n\n// æ­£ã—ã„ãƒãƒ¼ãƒ‰åã«ä¿®æ­£\nconst allSheetData = $('Google Sheetsèª­ã¿è¾¼ã¿').all();\n\nconst automationSteps = allSheetData.filter(item => \n  item.json.automation_en === currentAutomation\n);\n\nconsole.log(`Processing Automation: ${currentAutomation}`);\nconsole.log(`Found ${automationSteps.length} steps for this automation`);\n\nreturn automationSteps;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        60
      ],
      "id": "5256cc0c-d156-4f5c-9ace-c55d029889cc",
      "name": "è©²å½“ãƒ‡ãƒ¼ã‚¿æŠ½å‡º"
    },
    {
      "parameters": {
        "jsCode": "// Marketing Cloud â†’ Snowflake SQLå¤‰æ›ï¼ˆæ–°ã‚«ãƒ©ãƒ æ§‹é€ å¯¾å¿œï¼‰\nconst items = $input.all();\n\nreturn items.map(item => {\n  // Marketing Cloud â†’ Snowflake SQLå¤‰æ›é–¢æ•°\n  function convertMcToSnowflake(sqlQuery) {\n    if (typeof sqlQuery !== 'string') return sqlQuery;\n    \n    return sqlQuery\n      // è§’æ‹¬å¼§ã§å›²ã¾ã‚ŒãŸã‚«ãƒ©ãƒ åã‚’äºŒé‡å¼•ç”¨ç¬¦ã«å¤‰æ›\n      .replace(/\\[([^\\]]+)\\]/g, '\"$1\"')\n      \n      // Marketing Cloudæ—¥ä»˜é–¢æ•°ã‚’Snowflakeç”¨ã«å¤‰æ›\n      .replace(/FORMAT\\s*\\(\\s*([^,]+),\\s*'([^']+)'\\s*\\)/gi, 'TO_CHAR($1, \\'$2\\')')\n      .replace(/GETDATE\\s*\\(\\s*\\)/gi, 'CURRENT_TIMESTAMP()')\n      .replace(/DATEADD\\s*\\(\\s*day\\s*,/gi, 'DATEADD(DAY,')\n      .replace(/DATEADD\\s*\\(\\s*hh\\s*,/gi, 'DATEADD(HOUR,')\n      \n      // ãã®ä»–ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†\n      .replace(/'/g, \"''\")           // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—\n      .replace(/\\n/g, ' ')           // æ”¹è¡Œã‚’ç©ºç™½ã«\n      .replace(/\\r/g, '')            // ã‚­ãƒ£ãƒªãƒƒã‚¸ãƒªã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤\n      .replace(/\\s+/g, ' ')          // é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«\n      .trim();\n  }\n\n  return {\n    json: {\n      automation_name_en: item.json.automation_name_en,\n      step_name_en: item.json.step_en,\n      code: convertMcToSnowflake(item.json.code),\n      table: item.json.table,\n      data_action: item.json.data_action\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1220,
        60
      ],
      "id": "6228eddc-fcc3-4c4b-a014-b0eb5680aac0",
      "name": "MC-Snowflakeå¤‰æ›"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "MERGE INTO mc_automation_studios AS target\nUSING (\n    SELECT '{{ $json.automation_name_en }}' as automation_name_en\n) AS source\nON target.automation_name_en = source.automation_name_en\nWHEN NOT MATCHED THEN\n    INSERT (automation_name_en, automation_description, status)\n    VALUES (\n        source.automation_name_en,\n        'Migration from Marketing Cloud: ' || source.automation_name_en,\n        'ACTIVE'\n    )\nWHEN MATCHED THEN\n    UPDATE SET updated_at = CURRENT_TIMESTAMP()"
      },
      "type": "n8n-nodes-base.snowflake",
      "typeVersion": 1,
      "position": [
        1400,
        60
      ],
      "id": "79ab9721-032a-4cd8-9c0c-4311d6bec12b",
      "name": "Automationç™»éŒ²",
      "alwaysOutputData": false,
      "executeOnce": false,
      "notesInFlow": false,
      "credentials": {
        "snowflake": {
          "id": "JbIzaQVbUV9HdkL2",
          "name": "n8n_poc"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- UPSERTæ–¹å¼ï¼šé‡è¤‡æ™‚ã¯æ›´æ–°ã€å­˜åœ¨ã—ãªã„æ™‚ã¯æŒ¿å…¥\nMERGE INTO mc_automation_steps AS target\nUSING (\n    SELECT \n        (SELECT id FROM mc_automation_studios WHERE automation_name_en = '{{ $('MC-Snowflakeå¤‰æ›').first().json.automation_name_en }}') as automation_id,\n        '{{ $('MC-Snowflakeå¤‰æ›').first().json.automation_name_en }}' as automation_name_en,\n        '{{ $('MC-Snowflakeå¤‰æ›').first().json.step_name_en }}' as step_name_en,\n        COALESCE(\n            (SELECT MAX(step_order) + 1 \n             FROM mc_automation_steps \n             WHERE automation_id = (SELECT id FROM mc_automation_studios WHERE automation_name_en = '{{ $('MC-Snowflakeå¤‰æ›').first().json.automation_name_en }}')), \n            1\n        ) as step_order,\n        '{{ $('MC-Snowflakeå¤‰æ›').first().json.target_table }}' as target_table,\n        '{{ $('MC-Snowflakeå¤‰æ›').first().json.data_action }}' as data_action,\n        'ORIGINAL_QUERY_PLACEHOLDER' as original_query,\n        '{{ $('MC-Snowflakeå¤‰æ›').first().json.code }}' as optimized_query,\n        'Loopå‡¦ç†ã«ã‚ˆã‚‹è‡ªå‹•æœ€é©åŒ–' as optimization_note,\n        'SUCCESS' as conversion_status\n    WHERE '{{ $('MC-Snowflakeå¤‰æ›').first().json.step_name_en }}' IS NOT NULL\n      AND '{{ $('MC-Snowflakeå¤‰æ›').first().json.step_name_en }}' != 'undefined'\n      AND TRIM('{{ $('MC-Snowflakeå¤‰æ›').first().json.step_name_en }}') != ''\n      AND '{{ $('MC-Snowflakeå¤‰æ›').first().json.automation_name_en }}' IS NOT NULL\n      AND '{{ $('MC-Snowflakeå¤‰æ›').first().json.automation_name_en }}' != 'undefined'\n      AND TRIM('{{ $('MC-Snowflakeå¤‰æ›').first().json.automation_name_en }}') != ''\n) AS source\nON target.automation_name_en = source.automation_name_en \n   AND target.step_name_en = source.step_name_en\nWHEN NOT MATCHED THEN\n    INSERT (automation_id, automation_name_en, step_name_en, step_order, target_table, \n            data_action, original_query, optimized_query, optimization_note, conversion_status)\n    VALUES (source.automation_id, source.automation_name_en, source.step_name_en, \n            source.step_order, source.target_table, source.data_action, source.original_query, \n            source.optimized_query, source.optimization_note, source.conversion_status)\nWHEN MATCHED THEN\n    UPDATE SET \n        optimized_query = source.optimized_query,\n        optimization_note = source.optimization_note,\n        conversion_status = source.conversion_status,\n        created_at = CURRENT_TIMESTAMP();"
      },
      "type": "n8n-nodes-base.snowflake",
      "typeVersion": 1,
      "position": [
        1580,
        60
      ],
      "id": "5658a0e1-13a1-42c7-942d-6cdcc5b85020",
      "name": "Stepsç™»éŒ²",
      "credentials": {
        "snowflake": {
          "id": "JbIzaQVbUV9HdkL2",
          "name": "n8n_poc"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ç¾åœ¨ã®Automationã®å…¨ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å–å¾—\nSELECT \n    a.automation_name_en,\n    COUNT(s.step_order) as total_steps,\n    LISTAGG(\n        CONCAT(\n            '-- ================================================', CHAR(10),\n            '-- Step ', s.step_order::STRING, ': ', s.step_name_en, CHAR(10),\n            '-- Target: ', COALESCE(s.target_table, 'Unknown'), ' (', COALESCE(s.data_action, 'Unknown'), ')', CHAR(10),\n            '-- ================================================', CHAR(10), CHAR(10),\n            s.optimized_query, ';', CHAR(10), CHAR(10)\n        ),\n        ''\n    ) WITHIN GROUP (ORDER BY s.step_order) as combined_sql,\n    CURRENT_TIMESTAMP()::STRING as created_at\nFROM mc_automation_studios a\nJOIN mc_automation_steps s ON a.id = s.automation_id\nWHERE s.conversion_status = 'SUCCESS'\n  AND a.automation_name_en = '{{ $('è©²å½“ãƒ‡ãƒ¼ã‚¿æŠ½å‡º').item.json.automation_en }}'\nGROUP BY a.automation_name_en\nLIMIT 1;"
      },
      "type": "n8n-nodes-base.snowflake",
      "typeVersion": 1,
      "position": [
        1760,
        60
      ],
      "id": "063b0b4a-8f2b-4ddd-8fdd-08106dca298d",
      "name": "çµ±åˆãƒ‡ãƒ¼ã‚¿å–å¾—",
      "credentials": {
        "snowflake": {
          "id": "JbIzaQVbUV9HdkL2",
          "name": "n8n_poc"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Claude APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç† (Windowsäº’æ›ãƒ»çµµæ–‡å­—å¯¾å¿œç‰ˆ)\nconst items = $input.all();\nconst response = items[0].json;\nconst previousData = $node[\"Claudeç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™\"].json;\n\nconst claudeResponse = response.content[0].text;\nconst sqlMatch = claudeResponse.match(/```sql\\n([\\s\\S]*?)\\n```/);\nlet integratedQuery = sqlMatch ? sqlMatch[1] : claudeResponse;\n\n// SQLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ï¼ˆWindowsäº’æ›ãƒ»çµµæ–‡å­—å¯¾å¿œï¼‰\nfunction escapeSqlForSnowflake(str) {\n  if (typeof str !== 'string') return '';\n  return str\n    // çµµæ–‡å­—ã¨ç‰¹æ®ŠUnicodeã‚’å®‰å…¨ãªæ–‡å­—ã«ç½®æ›\n    .replace(/[\\u{1F600}-\\u{1F64F}]/gu, '[FACE]')      // ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ¤£ğŸ˜‚ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜ŠğŸ˜‡\n    .replace(/[\\u{1F300}-\\u{1F5FF}]/gu, '[SYMBOL]')    // ğŸŒ€ğŸŒğŸŒ‚â­â›„âš¡ğŸ”¥ğŸ’§ğŸŒŠ\n    .replace(/[\\u{1F680}-\\u{1F6FF}]/gu, '[TRANSPORT]') // ğŸš€ğŸšğŸš‚ğŸšƒğŸš„ğŸš…ğŸš†ğŸš‡ğŸšˆğŸš‰\n    .replace(/[\\u{1F1E0}-\\u{1F1FF}]/gu, '[FLAG]')      // ğŸ‡¦ğŸ‡§ğŸ‡¨ğŸ‡©ğŸ‡ªğŸ‡«ğŸ‡¬ğŸ‡­ğŸ‡®ğŸ‡¯\n    .replace(/[\\u{2600}-\\u{26FF}]/gu, '[MISC]')        // â˜€â˜â˜‚â˜ƒâ˜„â˜…â˜†â˜‡â˜ˆâ˜‰\n    .replace(/[\\u{2700}-\\u{27BF}]/gu, '[DINGBAT]')     // âœ‚âœƒâœ„âœ…âœ†âœ‡âœˆâœ‰âœŠ\n    .replace(/[\\u{1F900}-\\u{1F9FF}]/gu, '[EMOJI]')     // ğŸ¤ğŸ¤‘ğŸ¤’ğŸ¤“ğŸ¤”ğŸ¤•ğŸ¤–ğŸ¤—\n    \n    // é€šå¸¸ã®SQLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†\n    .replace(/'/g, \"''\")           // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—\n    .replace(/\\\\/g, '\\\\\\\\')        // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—\n    .replace(/\"/g, '\"\"')           // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—\n    .replace(/\\n/g, ' ')           // æ”¹è¡Œã‚’ç©ºç™½ã«\n    .replace(/\\r/g, '')            // ã‚­ãƒ£ãƒªãƒƒã‚¸ãƒªã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤\n    .replace(/\\s+/g, ' ')          // é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«\n    .replace(/\\t/g, ' ')           // ã‚¿ãƒ–ã‚’ç©ºç™½ã«\n    .trim();\n}\n\nconst worksheetName = `${previousData.automation_name}_Integrated_${new Date().toISOString().split('T')[0]}`;\n\nreturn [{\n  json: {\n    automation_name: previousData.automation_name,\n    original_steps: previousData.total_steps,\n    original_sql: previousData.original_sql,\n    \n    // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ¸ˆã¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ \n    original_sql_escaped: escapeSqlForSnowflake(previousData.original_sql),\n    integrated_sql: integratedQuery.trim(),\n    integrated_sql_escaped: escapeSqlForSnowflake(integratedQuery),\n    claude_full_response: claudeResponse,\n    claude_response_escaped: escapeSqlForSnowflake(claudeResponse),\n    \n    worksheet_name: worksheetName,\n    optimization_type: \"claude_integrated\",\n    created_at: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2280,
        60
      ],
      "id": "25b7de36-7a94-4562-90dc-5cdf904f4fe5",
      "name": "çµæœå‡¦ç†"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "={\n  \"Content-Type\": \"application/json\",\n  \"x-api-key\": \"{{ $vars.for_n8n_api_key }}\",\n  \"anthropic-version\": \"2023-06-01\"\n}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"model\": \"claude-sonnet-4-20250514\", \"max_tokens\": 4000, \"temperature\": 0.3, \"messages\": [ { \"role\": \"user\", \"content\": $json.prompt } ] } }}",
        "options": {
          "timeout": 120000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2120,
        60
      ],
      "id": "d78c6b53-e6a6-4b0a-b458-c57609efbbd3",
      "name": "Claude APIçµ±åˆæœ€é©åŒ–",
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "jsCode": "// çµ±åˆãƒ‡ãƒ¼ã‚¿å–å¾—ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™\nconst data = $input.first().json;\n\nconst automationName = data.AUTOMATION_NAME_EN;  // å¤§æ–‡å­—ã«ä¿®æ­£\nconst totalSteps = data.TOTAL_STEPS;             // å¤§æ–‡å­—ã«ä¿®æ­£\nconst combinedSql = data.COMBINED_SQL;           // å¤§æ–‡å­—ã«ä¿®æ­£\n\n// Claude APIã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰\nconst prompt = `ã‚ãªãŸã¯Snowflake SQLã®æœ€é©åŒ–ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚\n\nä»¥ä¸‹ã®MarketingCloud AutomationStudioã€Œ${automationName}ã€ã®è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã‚¯ã‚¨ãƒªã‚’åˆ†æã—ã€\n1ã¤ã®çµ±åˆã•ã‚ŒãŸæœ€é©åŒ–ã‚¯ã‚¨ãƒªã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚\n\n**Automationå**: ${automationName}\n**ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°**: ${totalSteps}\n\n**ç¾åœ¨ã®å€‹åˆ¥ã‚¹ãƒ†ãƒƒãƒ—ã‚¯ã‚¨ãƒª**:\n${combinedSql}\n\n**è¦æ±‚äº‹é …**:\n1. å…¨ã‚¹ãƒ†ãƒƒãƒ—ã®å‡¦ç†ã‚’è«–ç†çš„ã«çµ±åˆ\n2. ä¸è¦ãªä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚’å‰Šé™¤\n3. CTEã¾ãŸã¯ã‚µãƒ–ã‚¯ã‚¨ãƒªã§åŠ¹ç‡åŒ–\n4. ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡å‡¦ç†ã‚’æ’é™¤\n5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–\n\n**å‡ºåŠ›å½¢å¼**:\n- çµ±åˆã•ã‚ŒãŸSnowflakeå®Ÿè¡Œå¯èƒ½SQL\n- æœ€é©åŒ–ã®èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆä»˜ã\n- å…ƒã‚¹ãƒ†ãƒƒãƒ—ã¨ã®å¯¾å¿œé–¢ä¿‚ã‚’æ˜è¨˜\n\nçµ±åˆæœ€é©åŒ–ã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;\n\nreturn [{\n  json: {\n    automation_name: automationName,\n    total_steps: totalSteps,\n    prompt: prompt,\n    original_sql: combinedSql\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1940,
        60
      ],
      "id": "0e897ecf-efe6-4690-9eff-f245eaa221b0",
      "name": "Claudeç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Loop Step 10: Claudeçµ±åˆçµæœä¿å­˜ (ç°¡ç•¥ç‰ˆ)\nMERGE INTO mc_integrated_worksheets AS target\nUSING (\n    SELECT \n        '{{ $('çµæœå‡¦ç†').first().json.automation_name }}' as automation_name_en,\n        CAST('{{ $('çµæœå‡¦ç†').first().json.original_steps }}' AS NUMBER) as original_steps_count,\n        '{{ $('çµæœå‡¦ç†').first().json.worksheet_name }}' as worksheet_name,\n        'claude_integrated' as optimization_type,\n        CURRENT_TIMESTAMP() as created_at,\n        'SUCCESS' as status\n) AS source\nON target.automation_name_en = source.automation_name_en \n   AND target.optimization_type = source.optimization_type\nWHEN NOT MATCHED THEN\n    INSERT (automation_name_en, original_steps_count, worksheet_name, \n            optimization_type, created_at, status)\n    VALUES (source.automation_name_en, source.original_steps_count, source.worksheet_name,\n            source.optimization_type, source.created_at, source.status)\nWHEN MATCHED THEN\n    UPDATE SET \n        original_steps_count = source.original_steps_count,\n        worksheet_name = source.worksheet_name,\n        created_at = source.created_at,\n        status = source.status;"
      },
      "type": "n8n-nodes-base.snowflake",
      "typeVersion": 1,
      "position": [
        2500,
        60
      ],
      "id": "d6cf00b4-230c-4e16-b303-403c3564cc01",
      "name": "æœ€é©åŒ–ã‚¯ã‚¨ãƒªãƒ¬ã‚³ãƒ¼ãƒ‰ä¿å­˜",
      "credentials": {
        "snowflake": {
          "id": "JbIzaQVbUV9HdkL2",
          "name": "n8n_poc"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’é™¤å»ã—ã¦SQLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†\nconst items = $input.all();\n\nreturn items.map(item => {\n  // SQLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†é–¢æ•°\n  function escapeSql(str) {\n    if (typeof str !== 'string') return str;\n    return str\n      .replace(/\\n/g, ' ')           // æ”¹è¡Œã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›\n      .replace(/\\r/g, '')            // ã‚­ãƒ£ãƒªãƒƒã‚¸ãƒªã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤\n      .replace(/\\s+/g, ' ')          // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«\n      .replace(/'/g, \"''\")           // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—\n      .replace(/\\\\/g, '\\\\\\\\')        // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—\n      .trim();                       // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤\n  }\n\n  return {\n    json: {\n      automation_name_en: escapeSql(item.json.automation_en),\n      step_en: item.json.step_en,\n      code: escapeSql(item.json.code),\n      table: escapeSql(item.json.table),\n      data_action: escapeSql(item.json.data_action)\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1060,
        60
      ],
      "id": "ad2a8092-cf80-48db-8caf-15260185d399",
      "name": "SQLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Google Sheetsèª­ã¿è¾¼ã¿",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "è©²å½“ãƒ‡ãƒ¼ã‚¿æŠ½å‡º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheetsèª­ã¿è¾¼ã¿": {
      "main": [
        [
          {
            "node": "Automationä¸€è¦§æŠ½å‡º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Automationä¸€è¦§æŠ½å‡º": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è©²å½“ãƒ‡ãƒ¼ã‚¿æŠ½å‡º": {
      "main": [
        [
          {
            "node": "SQLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MC-Snowflakeå¤‰æ›": {
      "main": [
        [
          {
            "node": "Automationç™»éŒ²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Automationç™»éŒ²": {
      "main": [
        [
          {
            "node": "Stepsç™»éŒ²",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stepsç™»éŒ²": {
      "main": [
        [
          {
            "node": "çµ±åˆãƒ‡ãƒ¼ã‚¿å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµ±åˆãƒ‡ãƒ¼ã‚¿å–å¾—": {
      "main": [
        [
          {
            "node": "Claudeç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµæœå‡¦ç†": {
      "main": [
        [
          {
            "node": "æœ€é©åŒ–ã‚¯ã‚¨ãƒªãƒ¬ã‚³ãƒ¼ãƒ‰ä¿å­˜",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude APIçµ±åˆæœ€é©åŒ–": {
      "main": [
        [
          {
            "node": "çµæœå‡¦ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claudeç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™": {
      "main": [
        [
          {
            "node": "Claude APIçµ±åˆæœ€é©åŒ–",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœ€é©åŒ–ã‚¯ã‚¨ãƒªãƒ¬ã‚³ãƒ¼ãƒ‰ä¿å­˜": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SQLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†": {
      "main": [
        [
          {
            "node": "MC-Snowflakeå¤‰æ›",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "54805022-c776-4c46-9fca-3232badc7b36",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "573e3a89e0aefabc134b1e9cac06f24b8c45ef87afe4024c2c347c19fccc7b47"
  },
  "id": "tkIO350MktKLYHy2",
  "tags": []
}